<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Streamer - æ•°å­—äººç›´æ’­</title>
    <style>
        /* --- CSS æ ·å¼å®Œå…¨ä¿æŒä¸å˜ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }
        .container { max-width: 1200px; width: 100%; display: flex; flex-direction: column; gap: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .controls {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
        }
        .controls input {
            flex: 1; min-width: 200px; padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px;
            background: rgba(255, 255, 255, 0.9); color: #333;
        }
        .controls button {
            padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: all 0.3s; background: #4CAF50; color: white;
        }
        .controls button:hover:not(:disabled) { background: #45a049; transform: translateY(-2px); }
        .controls button:disabled { background: #666; cursor: not-allowed; opacity: 0.6; }
        .controls button.stop { background: #f44336; }
        .stage-container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px;
            display: flex; justify-content: center; align-items: center; min-height: 600px; position: relative;
        }
        #live2d-canvas { border-radius: 10px; background: rgba(255, 255, 255, 0.05); }
        .status {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .status-item { display: flex; align-items: center; gap: 10px; }
        .status-indicator {
            width: 12px; height: 12px; border-radius: 50%; background: #666; animation: pulse 2s infinite;
        }
        .status-indicator.connected { background: #4CAF50; }
        .status-indicator.playing { background: #2196F3; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .text-display {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px;
            min-height: 100px; max-height: 200px; overflow-y: auto;
        }
        .error {
            background: rgba(244, 67, 54, 0.8); border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px; padding: 15px; margin-top: 10px; display: none;
        }
        .error.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ AI Streamer</h1>
            <p>24/7 æ•°å­—äººç›´æ’­æ¼”ç¤º</p>
        </div>

        <div class="controls">
            <input type="text" id="topic-input" placeholder="è¾“å…¥ä¸»é¢˜..." value="å’–å•¡æœº">
            <button id="start-btn">å¼€å§‹ç›´æ’­</button>
            <button id="stop-btn" class="stop" disabled>åœæ­¢ç›´æ’­</button>
        </div>

        <div class="error" id="error-message"></div>

        <div class="stage-container">
            <canvas id="live2d-canvas"></canvas>
        </div>

        <div class="status">
            <div class="status-item"><div class="status-indicator" id="connection-status"></div><span id="connection-text">æœªè¿æ¥</span></div>
            <div class="status-item"><div class="status-indicator" id="playback-status"></div><span id="playback-text">ç­‰å¾…ä¸­</span></div>
            <div class="status-item"><span>å½“å‰æ–‡æ¡ˆï¼š</span><span id="current-script">-</span></div>
        </div>

        <div class="text-display">
            <div class="current-text" id="current-text">ç­‰å¾…å¼€å§‹...</div>
            <div class="status-text" id="status-text"></div>
        </div>
    </div>

    <script src="/static/lib/pixi.min.js"></script>
    
    <script src="/static/lib/live2d.min.js"></script>
    
    <script src="/static/lib/live2dcubismcore.min.js"></script>
    
    <script src="/static/lib/index.min.js"></script>

    <script>
        // UI å…ƒç´ å¼•ç”¨
        const ui = {
            canvas: document.getElementById('live2d-canvas'),
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            topicInput: document.getElementById('topic-input'),
            errorBox: document.getElementById('error-message'),
            connStatus: document.getElementById('connection-status'),
            connText: document.getElementById('connection-text'),
            playStatus: document.getElementById('playback-status'),
            playText: document.getElementById('playback-text'),
            currentText: document.getElementById('current-text'),
            currentScript: document.getElementById('current-script'),
            statusText: document.getElementById('status-text')
        };

        let app, model, ws, audioCtx;

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯
        function showError(msg) {
            ui.errorBox.innerText = msg;
            ui.errorBox.classList.add('show');
            setTimeout(() => ui.errorBox.classList.remove('show'), 5000);
            console.error(msg);
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€
        function updateStatus(msg) { ui.statusText.innerText = `[ç³»ç»Ÿ] ${msg}`; }

        // === 1. åˆå§‹åŒ– Live2D ===
        async function initLive2D() {
            try {
                // æ£€æŸ¥æœ¬åœ°åº“æ˜¯å¦åŠ è½½
                if (!window.PIXI) throw new Error("PixiJS æœªåŠ è½½ (æ£€æŸ¥ static/lib/pixi.min.js)");
                
                // è‡ªåŠ¨æŒ‚è½½æ’ä»¶
                if (window.PixiLive2dDisplay) window.PIXI.live2d = window.PixiLive2dDisplay;
                if (!window.PIXI.live2d) throw new Error("Live2D æ’ä»¶æœªåŠ è½½ (æ£€æŸ¥ static/lib/index.min.js)");

                app = new PIXI.Application({
                    view: ui.canvas,
                    autoStart: true,
                    backgroundAlpha: 0,
                    resizeTo: document.querySelector('.stage-container')
                });

                updateStatus("æ­£åœ¨åŠ è½½ Hiyori æ¨¡å‹...");
                
                // åŠ è½½æœ¬åœ°æ¨¡å‹
                const modelPath = '/static/models/Hiyori/Hiyori.model3.json';
                model = await PIXI.live2d.Live2DModel.from(modelPath);

                // è°ƒæ•´ä½ç½®
                const scale = Math.min(app.screen.width / model.width, app.screen.height / model.height) * 0.8;
                model.scale.set(scale);
                model.x = (app.screen.width - model.width) / 2;
                model.y = (app.screen.height - model.height) / 2 + (app.screen.height * 0.1);

                app.stage.addChild(model);
                updateStatus("æ¨¡å‹åŠ è½½æˆåŠŸï¼Œå‡†å¤‡å°±ç»ª");
                
                // ç‚¹å‡»æµ‹è¯•
                model.on('hit', () => model.motion('Tap'));

            } catch (e) {
                let extra = "";
                if (e.message.includes("404")) extra = " (æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥è·¯å¾„)";
                showError("åˆå§‹åŒ–å¤±è´¥: " + e.message + extra);
            }
        }

        // === 2. ç›´æ’­åŠŸèƒ½ ===
        ui.startBtn.onclick = async () => {
            const topic = ui.topicInput.value.trim();
            if (!topic) return showError("è¯·è¾“å…¥ä¸»é¢˜");

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            ui.startBtn.disabled = true;
            ui.topicInput.disabled = true;
            updateStatus("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");

            try {
                // è°ƒç”¨ API
                const res = await fetch(`/api/start_stream?topic=${encodeURIComponent(topic)}`, {method:'POST'});
                if (!res.ok) throw new Error("å¯åŠ¨å¤±è´¥");

                // WebSocket è¿æ¥
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${location.host}/ws/stream`);

                ws.onopen = () => {
                    ui.connStatus.className = 'status-indicator connected';
                    ui.connText.innerText = 'å·²è¿æ¥';
                    ui.stopBtn.disabled = false;
                    updateStatus("ç›´æ’­å·²å¼€å§‹");
                };

                ws.onmessage = async (e) => {
                    const msg = JSON.parse(e.data);
                    if (msg.type === 'audio_chunk') {
                        ui.currentText.innerText = msg.text;
                        ui.currentScript.innerText = msg.text.substring(0, 15) + '...';
                        ui.playStatus.className = 'status-indicator playing';
                        ui.playText.innerText = 'è¯´è¯ä¸­';
                        
                        await playAudio(msg.audio_data);
                        
                        // ç®€å•çš„å£å‹/åŠ¨ä½œ
                        if (model.internalModel && model.internalModel.coreModel) {
                            model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 1.0);
                            setTimeout(() => model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0), 200);
                        }
                    } else if (msg.type === 'status') {
                        updateStatus(msg.message);
                    }
                };
                
                ws.onerror = () => showError("WS è¿æ¥é”™è¯¯");
                ws.onclose = () => stopStreamUI();

            } catch (e) {
                showError(e.message);
                ui.startBtn.disabled = false;
                ui.topicInput.disabled = false;
            }
        };

        ui.stopBtn.onclick = () => {
            if(ws) ws.close();
            stopStreamUI();
        };

        function stopStreamUI() {
            ui.connStatus.className = 'status-indicator';
            ui.connText.innerText = 'æœªè¿æ¥';
            ui.playStatus.className = 'status-indicator';
            ui.playText.innerText = 'ç­‰å¾…ä¸­';
            ui.startBtn.disabled = false;
            ui.stopBtn.disabled = true;
            ui.topicInput.disabled = false;
            updateStatus("ç›´æ’­å·²åœæ­¢");
        }

        async function playAudio(hex) {
            if (!audioCtx) return;
            const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
            const buf = audioCtx.createBuffer(1, bytes.length/2, 24000);
            const chan = buf.getChannelData(0);
            const view = new DataView(bytes.buffer);
            for(let i=0; i<bytes.length/2; i++) chan[i] = view.getInt16(i*2, true)/32768.0;
            
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            src.connect(audioCtx.destination);
            src.onended = () => {
                ui.playStatus.className = 'status-indicator';
                ui.playText.innerText = 'ç­‰å¾…ä¸­';
            };
            src.start(0);
        }

        // å¯åŠ¨
        window.onload = initLive2D;
    </script>
</body>
</html>